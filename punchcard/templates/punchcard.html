<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="robots" content="index, nofollow">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <meta charset="UTF-8">
        <title>Punchcard</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Amarante&family=Aubrey&family=Caveat:wght@400..700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="/static/style.css">
        <script>
            function punch(element, url, month, date) {
                const punch = !element.classList.contains('punched');
                fetch(url, {
                    method: 'PUT',
                    body: JSON.stringify({
                        month: month,
                        day: date,
                        punch: punch
                    }),
                    headers: {'Content-type': 'application/json'}
                }).then(() => {
                    element.classList.toggle('punched');
                    element.classList.toggle('unpunched');
                })
            }

            function changeYear(year) {
                if (year === "new") {
                    const y = prompt("What year is this card for?");
                    if (!y) {
                        return;
                    }
                    const l = prompt("What is this card called?");
                    if (!l) {
                        return;
                    }
                    if (confirm(`Create new card ${y}: "${l}"?`)) {
                        fetch(`{{url_for("create_punchcard")}}`, {
                            method: 'POST',
                            headers: {'Content-type': 'application/json'},
                            body: JSON.stringify({
                                year: y,
                                label: l
                            })
                        }).then(() => {
                            window.location.replace(`{{url_for("get_punchcard")}}` + `?year=${y}`);
                        })
                    }
                    return;
                }
                window.location.replace(`{{url_for("get_punchcard")}}` + `?year=${year}`);
            }

            function updateLabel(e, url, original) {
                e.preventDefault();
                const form = new FormData(e.target);
                const data = Object.fromEntries(form.entries());

                if (original === data.label) {
                    document.activeElement.blur();
                    return;
                }
                fetch(url, {
                    method: 'PUT',
                    headers: {'Content-type': 'application/json'},
                    body: JSON.stringify({
                        'label': data.label,
                    }),
                }).then(() => {
                    document.activeElement.blur();
                });
            }

            function deletePunchcard(e, url, name) {
                e.preventDefault();
                if (confirm(`Delete punchcard "${name}"?`)) {
                    fetch(url, {
                        method: 'DELETE',
                        headers: {'Content-type': 'application/json'},
                    }).then(() => {
                        window.location.reload();
                    });
                }
            }

            function logout() {
                if (confirm('Logout? You will need to enter your credentials again.')) {
                    window.location.href = '/logout';
                }
            }

            window.onload = () => {
                if ({{ auto_refresh_timeout }} >= 0) {
                    sessionStorage.setItem("pageLoadedAt", Date.now());
                }
            }
            window.onfocus = () => {
                const refreshTimeout = {{ auto_refresh_timeout }};
                if (refreshTimeout < 0) {
                    return;
                }
                const loadedAt = sessionStorage.getItem("pageLoadedAt");
                if (!!loadedAt && (Date.now() - loadedAt >= refreshTimeout)) {
                    sessionStorage.removeItem("pageLoadedAt");
                    location.reload();
                }
            }
        </script>
    </head>
    <body>
        {% if years|length %}
            <select id="yearPicker" onchange="changeYear(this.value)" class="yearPicker">
                {% for y in years %}
                    <option value={{y}} {{"selected" if y == year else ""}}>{{y}}</option>
                {% endfor %}
            </select>
        {% endif %}
        <button onclick="changeYear('new')" class="newcardbutton">New</button>
        <button onclick="logout()" class="newcardbutton" style="margin-left: 10px;">Logout</button>
        <div>
            {% for punchcard in punchcards %}
                <div class="punchcard">
                    <form onsubmit='return updateLabel(event, "{{url_for("update_punchcard", id=punchcard.id)}}", "{{punchcard.label}}")' class="headerForm" autocomplete="off">
                        <input type="hidden" name="punchcardId" value="{{punchcard.id}}" />
                        <input type="text" class="caveat headerInput" value="{{punchcard.label}}" name="label" />
                        <div class="headerButtons">
                            <button class="headerFormButton" type="submit" name="action" value="Update">Update</button>
                            <input class="headerFormButton" type="reset" name="action" value="Cancel" onclick="document.activeElement.blur()" />
                            <input class="headerFormButton" type="button" name="action" value="Delete" onclick='deletePunchcard(event, "{{url_for("delete_punchcard", id=punchcard.id)}}", "{{punchcard.label}}")'/>
                        </div>
                    </form>
                    <div class="punchgrid">
                        {% for header in punchcard.punches[0] %}
                        <div class="monthHeader">{{header}}</div>
                        {% endfor %}
                        {% for days in punchcard.punches[1:] %}
                            {% for day in days %}
                                {% if day[0] != -1 %}
                                    <div
                                        class='day {{"punched" if day[1] else "unpunched"}} {{"today" if loop.index == today.month and day[0] == today.date else ""}}'
                                        onclick='punch(this, "{{url_for("punch_punchcard", id=punchcard.id)}}", {{loop.index}}, {{day[0]}})'
                                            >{{day[0]}}</div>
                                {% else %}
                                    <div></div>
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </body>
</html>
